<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empire Slots</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            background: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100vh; margin: 0; overflow: hidden; 
        }
        .user-info { margin-bottom: 10px; text-align: center; }
        #username { color: #d4af37; font-weight: bold; }
        #balance-display { font-size: 1.5rem; margin: 10px 0; color: #f1c40f; }
        
        .slot-machine { 
            background: linear-gradient(145deg, #1e1e1e, #111); 
            border: 4px solid #d4af37; border-radius: 20px; 
            padding: 20px; box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); 
        }
        .reels { display: flex; gap: 10px; margin-bottom: 20px; }
        .reel { 
            width: 80px; height: 100px; background: #000; 
            border: 2px solid #333; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 3rem; overflow: hidden; position: relative; 
        }
        
        .controls { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .btn { 
            background: linear-gradient(45deg, #d4af37, #f1c40f); 
            border: none; padding: 12px 30px; color: #000; 
            font-weight: bold; border-radius: 50px; cursor: pointer; 
            font-size: 1.1rem; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4); 
        }
        .btn-exit { background: #333; color: #fff; font-size: 0.9rem; margin-top: 15px; }
        .btn:disabled { background: #555; box-shadow: none; cursor: not-allowed; }
        
        .status { margin-top: 15px; font-size: 1.1rem; color: #f1c40f; height: 1.5rem; text-align: center; }
    </style>
</head>
<body>

    <div class="user-info">
        <div id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="balance-display"><span id="balance-val">0</span> ‚òÖ</div>
    </div>

    <h2 style="color: #d4af37; letter-spacing: 2px; margin: 5px 0;">EMPIRE SLOTS</h2>

    <div class="slot-machine">
        <div class="reels">
            <div id="reel1" class="reel">üíé</div>
            <div id="reel2" class="reel">üíé</div>
            <div id="reel3" class="reel">üíé</div>
        </div>
        <div class="controls">
            <button id="spin-btn" class="btn" onclick="spin()">–ö–†–£–¢–ò–¢–¨ (5 ‚òÖ)</button>
        </div>
    </div>

    <div id="status" class="status"></div>

    <button class="btn btn-exit" onclick="closeApp()">–í–´–•–û–î –ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø</button>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –†–∞–±–æ—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        const urlParams = new URLSearchParams(window.location.search);
        let balance = parseInt(urlParams.get('balance')) || 0;
        const spinCost = 5;

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∏–∫–∞
        const user = tg.initDataUnsafe.user;
        document.getElementById('username').innerText = user ? (user.username ? "@" + user.username : user.first_name) : "–ò–≥—Ä–æ–∫";
        updateBalanceUI();

        // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –∏ —à–∞–Ω—Å–æ–≤ (–í–µ—Å–∞)
        // –ß–µ–º —á–∞—â–µ —Å–∏–º–≤–æ–ª –≤ –º–∞—Å—Å–∏–≤–µ, —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å –µ–≥–æ –≤—ã–ø–∞–¥–µ–Ω–∏—è
        const weightedSymbols = [
            'üçí', 'üçí', 'üçí', 'üçí', 'üçí', // –û—á–µ–Ω—å —á–∞—Å—Ç–æ
            'üåü', 'üåü', 'üåü', 'üåü',       // –ß–∞—Å—Ç–æ
            'üî•', 'üî•', 'üî•',             // –°—Ä–µ–¥–Ω–µ
            'üíé', 'üíé',                   // –†–µ–¥–∫–æ
            'üëë',                         // –û—á–µ–Ω—å —Ä–µ–¥–∫–æ
            'üé∞'                          // –î–∂–µ–∫–ø–æ—Ç (1/16 –Ω–∞ –æ–¥–∏–Ω —Ä–∏–ª)
        ];

        const reels = [
            document.getElementById('reel1'),
            document.getElementById('reel2'),
            document.getElementById('reel3')
        ];
        const statusText = document.getElementById('status');
        const spinBtn = document.getElementById('spin-btn');

        function updateBalanceUI() {
            document.getElementById('balance-val').innerText = balance;
        }

        function spin() {
            if (balance < spinCost) {
                statusText.innerText = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚òÖ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ!";
                return;
            }

            balance -= spinCost;
            updateBalanceUI();
            
            spinBtn.disabled = true;
            statusText.innerText = "–°—Ç–∞–≤–∫–∏ —Å–¥–µ–ª–∞–Ω—ã...";
            
            let spins = 0;
            const maxSpins = 15;
            
            const interval = setInterval(() => {
                reels.forEach(reel => {
                    const randomSymbol = weightedSymbols[Math.floor(Math.random() * weightedSymbols.length)];
                    reel.innerText = randomSymbol;
                });
                spins++;

                if (spins >= maxSpins) {
                    clearInterval(interval);
                    checkWin();
                }
            }, 100);
        }

        function checkWin() {
            const res = reels.map(reel => reel.innerText);
            spinBtn.disabled = false;
            let winAmount = 0;

            // –õ–æ–≥–∏–∫–∞ –≤—ã–∏–≥—Ä—ã—à–∞
            if (res[0] === res[1] && res[1] === res[2]) {
                // –¢—Ä–∏ –≤ —Ä—è–¥
                const symbol = res[0];
                if (symbol === 'üé∞') winAmount = 100;
                else if (symbol === 'üëë') winAmount = 50;
                else if (symbol === 'üíé') winAmount = 25;
                else winAmount = 15;

                statusText.innerText = `üéâ –í–´–ò–ì–†–´–®: ${winAmount} ‚òÖ!`;
                tg.HapticFeedback.notificationOccurred('success');
            } else if (res[0] === res[1] || res[1] === res[2] || res[0] === res[2]) {
                // –î–≤–µ —Å–æ–≤–ø–∞–ª–∏
                winAmount = 7;
                statusText.innerText = "üí∞ –ú–∞–ª—ã–π –ø—Ä–∏–∑: 7 ‚òÖ";
                tg.HapticFeedback.impactOccurred('medium');
            } else {
                statusText.innerText = "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑";
            }

            balance += winAmount;
            updateBalanceUI();
            syncBalance(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        }

        function syncBalance() {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è (–µ—Å–ª–∏ –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sendData –∑–∞–∫—Ä—ã–≤–∞–µ—Ç WebApp, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ
            const data = JSON.stringify({
                action: "update_balance",
                balance: balance
            });
            tg.sendData(data); 
        }

        function closeApp() {
            // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –í—ã—Ö–æ–¥ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º
            syncBalance();
            tg.close();
        }
    </script>
</body>
</html>
